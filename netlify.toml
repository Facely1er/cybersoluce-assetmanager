# Netlify deployment configuration for ERMITS CyberSoluceÂ®

[build]
  publish = "dist"
  command = "npm ci --include=dev && npm run build"

[build.environment]
  NODE_VERSION = "20"
  NPM_VERSION = "10"
  # Don't set NODE_ENV=production here - it prevents dev dependencies from installing
  # NODE_ENV will be set to production during the build process by Vite
  VITE_APP_ENV = "production"
  CI = "true"

# Redirect rules for SPA - catch-all for client-side routing
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  force = false

# Enhanced security headers for production
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains"
    # Content Security Policy (will be overridden by meta tag)
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://fonts.googleapis.com https://fonts.gstatic.com; worker-src 'self' blob:;"
    # Cross-Origin policies - relaxed for better compatibility
    # Cross-Origin-Embedder-Policy = "require-corp"  # Commented out - can break some resources
    Cross-Origin-Opener-Policy = "same-origin"
    # Cross-Origin-Resource-Policy = "same-origin"  # Commented out - can block external resources

# Enhanced caching for static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    # Add compression headers
    Vary = "Accept-Encoding"

# Cache JavaScript and CSS with versioning
[[headers]]
  for = "*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "application/javascript; charset=utf-8"

[[headers]]
  for = "*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "text/css; charset=utf-8"

# Cache fonts
[[headers]]
  for = "*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Cross-Origin-Resource-Policy = "cross-origin"

# Cache manifest and other meta files
[[headers]]
  for = "/manifest.json"
  [headers.values]
    Cache-Control = "public, max-age=86400"
    Content-Type = "application/manifest+json; charset=utf-8"

[[headers]]
  for = "/robots.txt"
  [headers.values]
    Cache-Control = "public, max-age=86400"
    Content-Type = "text/plain; charset=utf-8"

# API route headers
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# Environment variables for build
# Note: NODE_ENV is NOT set to production here to allow dev dependencies to install
# Vite will set NODE_ENV=production during its build process
[context.production.environment]
  VITE_APP_ENV = "production"
  VITE_DEBUG_MODE = "false"
  VITE_ENABLE_ERROR_REPORTING = "true"

[context.deploy-preview.environment]
  NODE_ENV = "production"
  VITE_APP_ENV = "preview"
  VITE_DEBUG_MODE = "true"

[context.branch-deploy.environment]
  NODE_ENV = "production"
  VITE_APP_ENV = "development"
  VITE_DEBUG_MODE = "true"

# Demo branch specific configuration
[context.demo.environment]
  NODE_ENV = "production"
  VITE_APP_ENV = "demo"
  VITE_DEBUG_MODE = "true"
  VITE_ENABLE_ERROR_REPORTING = "false"
  # Demo mode - Supabase optional (app will work without it)

# Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  # Production optimizations for functions
  external_node_modules = ["@supabase/supabase-js"]

# Enhanced plugin configuration
[[plugins]]
  package = "@netlify/plugin-lighthouse"
  
  [plugins.inputs.settings]
    output_path = "reports/lighthouse.html"
    # Production performance budgets
    budget_path = "performance-budget.json"
    
[[plugins]]
  package = "@netlify/plugin-sitemap"
  
  [plugins.inputs]
    buildDir = "dist"
    exclude = [
      "/admin/**",
      "/api/**"
    ]

[[plugins]]
  package = "netlify-plugin-checklinks"
  
  [plugins.inputs]
    entryPoints = ["dist/**/*.html"]
    checkExternal = false
    skipPatterns = ["localhost", "127.0.0.1"]

# Performance and build optimizations
[[plugins]]
  package = "netlify-plugin-inline-critical-css"

# Custom error pages
[[redirects]]
  from = "/admin/*"
  to = "/401.html"
  status = 401
  force = true
  conditions = {Role = ["!admin"]}

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Note: The catch-all redirect above handles 404s for SPA routing
# This duplicate redirect has been removed to avoid conflicts
